name: build-and-test

on:
  push:
  pull_request:

jobs:
  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_target: [all, server, client]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      - name: Install Qt (Windows UI deps)
        if: matrix.build_target != 'server'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qt5compat qtimageformats qtmultimedia'
      - name: Configure
        run: |
          $ErrorActionPreference = "Stop"
          if ("${{ matrix.build_target }}" -eq "server") {
            cmake -S . -B build -G "Ninja" -DBUILD_SERVER=ON -DBUILD_CLIENT_WINDOWS=OFF -DBUILD_SHARED_TESTS=ON -DCMAKE_BUILD_TYPE=Release
          } elseif ("${{ matrix.build_target }}" -eq "client") {
            cmake -S . -B build -G "Ninja" -DBUILD_SERVER=OFF -DBUILD_CLIENT_WINDOWS=ON -DBUILD_SHARED_TESTS=ON -DCMAKE_BUILD_TYPE=Release
          } else {
            cmake -S . -B build -G "Ninja" -DBUILD_SERVER=ON -DBUILD_CLIENT_WINDOWS=ON -DBUILD_SHARED_TESTS=ON -DCMAKE_BUILD_TYPE=Release
          }
      - name: Build
        env:
          NINJA_STATUS: "[%e sec | %f/%t | %r running] "
        run: cmake --build build --config Release -- -v
      - name: Test
        run: ctest --test-dir build --output-on-failure -C Release
      - name: Generate self-signed certs
        if: matrix.build_target == 'all'
        run: pwsh -File scripts/gen_certs.ps1 -OutputDir dist/certs -Password changeit
      - name: Package Windows deliverables
        if: matrix.build_target == 'all'
        run: |
          pwsh -File scripts/package_win.ps1 -BuildDir build/client/windows -OutputDir dist/win
          pwsh -File scripts/package_artifacts.ps1 -BuildServer build/server -BuildClientWin build/client/windows -Output dist/artifacts.zip -CertPath dist/certs -CertPassword changeit
      - name: Upload Release Bundle
        if: matrix.build_target == 'all'
        uses: actions/upload-artifact@v4
        with:
          name: mi-bundle-windows
          path: core/dist/artifacts.zip
      - name: Upload Artifacts (binaries)
        uses: actions/upload-artifact@v4
        with:
          name: mi-${{ matrix.build_target }}-windows-binaries
          path: |
            build/**/*.exe
            build/**/*.dll
            build/**/*.pdb
          if-no-files-found: ignore
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mi-${{ matrix.build_target }}-ctest-logs
          path: |
            build/Testing/**/*.xml
            build/Testing/**/*.log
          if-no-files-found: ignore
      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: |
            build/_deps
            build/vcpkg_installed
          key: cmake-cache-${{ runner.os }}-${{ matrix.build_target }}-${{ hashFiles('core/**/CMakeLists.txt') }}
          restore-keys: |
            cmake-cache-${{ runner.os }}-${{ matrix.build_target }}-

  windows-coverage:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-lxml
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-libxslt
      - name: Install gcovr
        env:
          PIP_BREAK_SYSTEM_PACKAGES: "1"
        run: |
          python -m pip install --upgrade --break-system-packages pip
          python -m pip install --break-system-packages --no-deps gcovr
      - name: Configure (coverage)
        run: |
          cmake -S . -B build-coverage -G "Ninja" \
            -DBUILD_SERVER=ON -DBUILD_CLIENT_WINDOWS=ON -DBUILD_SHARED_TESTS=ON \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="--coverage" -DCMAKE_CXX_FLAGS="--coverage"
      - name: Build (coverage)
        run: cmake --build build-coverage --config Debug
      - name: Test (coverage)
        run: ctest --test-dir build-coverage --output-on-failure -C Debug
      - name: Generate coverage report
        run: |
          gcovr -r core --filter core -j 2 --xml -o build-coverage/coverage.xml --html-details build-coverage/coverage.html
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-windows
          path: |
            build-coverage/coverage.xml
            build-coverage/coverage.html
          if-no-files-found: ignore

  android-placeholder:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('core/client/android/**') }}
      - name: Build Android placeholder
        working-directory: client/android
        run: |
          mkdir -p app/build/outputs/apk/debug
          echo '#!/bin/sh' > gradlew
          echo 'exit 0' >> gradlew
          chmod +x gradlew
          ./gradlew assembleDebug || true
          touch app/build/outputs/apk/debug/app-debug.apk
      - name: Upload Android placeholder
        uses: actions/upload-artifact@v4
        with:
          name: mi-android-placeholder
          path: |
            core/client/android/app/build/outputs/apk/debug/app-debug.apk
            core/client/android/README.md
          if-no-files-found: ignore
